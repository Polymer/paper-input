<!--
    @license
    Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<!--
@element paper-input
-->

<link rel="import" href="paper-input-underline.html">

<dom-module id="paper-input">

  <style>

    :host {
      display: block;
    }

    .content ::content input,
    .content ::content textarea {
      margin: 0;
      padding: 0.5em 0 0.25em;
      border: none;
      font: inherit;
      width: 100%;
    }

    ::-webkit-input-placeholder {
      color: #757575;
    }

    ::-moz-placeholder {
      color: #757575;
      opacity: 1;
    }

    :-ms-input-placeholder {
      color: #757575;
    }

    paper-input-underline {
      margin-bottom: 0.25em;
    }

    .add-on {
      color: #757575;
    }

    :host([focused]) .add-on {
      color: #4059a9;
    }

    :host([invalid][focused]) .add-on {
      color: #d34336;
    }

  </style>

  <template>

    <div class="content">
      <content select="input,textarea"></content>
    </div>

    <paper-input-underline id="underline"></paper-input-underline>

    <content select=".add-on"></content>

  </template>

</dom-module>

<script>

(function() {

  Polymer({

    is: 'paper-input',

    properties: {

      type: {
        type: String,
        value: 'text'
      },

      invalid: {
        readOnly: true,
        reflectToAttribute: true,
        type: Boolean,
        value: false
      },

      vaidateImmediately: {
        observer: 'validateImmediateChanged',
        type: Boolean
      }

    },

    listeners: {
      'mousedown': 'mousedownAction',
      'click': 'clickAction',
      'input': 'inputAction',
      'addon-register': 'addonRegisterAction'
    },

    inputSelector: 'input,textarea',

    ready: function() {
      this.addons = [];

      this.validate();

      this.addEventListener('focus', this.focusAction.bind(this), true);
      this.addEventListener('blur', this.blurAction.bind(this), true);
    },

    validate: function(inputElement) {
      // cache the input element
      if (inputElement) {
        this.inputElement = inputElement;
      } else if (this.inputElement) {
        inputElement = this.inputElement;
      } else {
        inputElement = this.inputElement = this.querySelector(this.inputSelector);
      }

      this.invalid = inputElement && !inputElement.validity.valid;
    },

    validateImmediatelyChanged: function() {
      if (this.validateImmediately) {
        this.validate();
      }
    },

    focusAction: function() {
      this.setAttribute('focused', '');
      this.$.underline.focused = true;
    },

    blurAction: function() {
      this.removeAttribute('focused');
      this.$.underline.focused = false;
    },

    mousedownAction: function(e) {
      var rect = this.$.underline.getBoundingClientRect();
      var right = e.x - rect.left;
      this.$.underline.style.mozTransformOrigin = right + 'px';
      this.$.underline.style.webkitTransformOrigin = right + 'px';
      this.$.underline.style.transformOriginX = right + 'px';
    },

    clickAction: function() {
      this.querySelector(this.inputSelector).focus();
    },

    inputAction: function(e) {
      if (this.validateImmediately) {
        this.validate(e.target);
      }
    },

    addonRegisterAction: function(e) {
      this.addons.push(e.target);
      e.target.initialize(this.querySelector(this.inputSelector));
    }

  });

})();
</script>
